<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress {
            height: 25px;
        }
        .stock-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .stock-card:hover {
            transform: translateY(-5px);
        }
        .metric-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .analysis-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .score-indicator {
            height: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .sentiment-positive {
            color: #198754;
        }
        .sentiment-negative {
            color: #dc3545;
        }
        .sentiment-neutral {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Stock Market Analysis Tool</h1>
        
        <!-- Analysis Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="market" class="form-label">Select Market</label>
                        <select class="form-select" id="market" name="market" required>
                            <option value="UK">UK (FTSE)</option>
                            <option value="US">US (S&P 500)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeNews" name="include_news" checked>
                            <label class="form-check-label" for="includeNews">
                                Include News Sentiment Analysis
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date" class="form-label">Analysis Date (Optional)</label>
                        <input type="date" class="form-control" id="date" name="date">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn">Start Analysis</button>
                </form>
            </div>
        </div>
        
        <!-- Progress Section -->
        <div id="progressSection" class="card mb-4 d-none">
            <div class="card-body">
                <h5 class="card-title">Analysis Progress</h5>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%" 
                         id="progressBar">
                        0%
                    </div>
                </div>
                <p id="progressStatus" class="mb-0">Initializing...</p>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="d-none">
            <h3 class="mb-4">Analysis Results</h3>
            <div id="reportContent" class="row"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set default date to current date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('date').value = dateStr;
        });

        document.getElementById('analysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show progress section and hide previous results
            document.getElementById('progressSection').classList.remove('d-none');
            document.getElementById('resultsSection').classList.add('d-none');
            document.getElementById('reportContent').innerHTML = '';
            
            const formData = new FormData(this);
            
            try {
                // Start analysis
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Analysis request failed');
                
                // Poll for progress
                const progressInterval = setInterval(async () => {
                    const progressResponse = await fetch('/progress');
                    const progressData = await progressResponse.json();
                    
                    document.getElementById('progressBar').style.width = `${progressData.percentage}%`;
                    document.getElementById('progressBar').textContent = `${progressData.percentage}%`;
                    document.getElementById('progressStatus').textContent = progressData.step;
                    
                    if (progressData.status === 'complete' && progressData.report) {
                        clearInterval(progressInterval);
                        displayResults(progressData.report);
                    } else if (progressData.status === 'error') {
                        clearInterval(progressInterval);
                        alert('Error during analysis: ' + progressData.step);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting analysis');
            }
        });
        
        function displayResults(report) {
            const resultsSection = document.getElementById('resultsSection');
            const reportContent = document.getElementById('reportContent');
            
            // Show results section
            resultsSection.classList.remove('d-none');
            
            // Parse the report text
            const stocks = report.split('==================================================').filter(stock => stock.trim());
            
            stocks.forEach((stock, index) => {
                const lines = stock.split('\n').filter(line => line.trim());
                if (lines.length < 3) return; // Skip if not enough data
                
                // Extract ticker and name
                const [symbol] = lines[0].split('.').map(s => s.trim());
                
                // Parse price data with error handling
                let currentPrice = 0;
                let predictedPrice = 0;
                let predictedReturn = 0;
                
                try {
                    // Parse current price
                    const currentPriceMatch = lines[1].match(/£([\d.]+)/);
                    if (currentPriceMatch) {
                        currentPrice = parseFloat(currentPriceMatch[1]);
                    }
                    
                    // Parse predicted price and return
                    const predictedPriceMatch = lines[2].match(/£([\d.]+).*\((Return|Return:)\s*([\-\d.]+)%\)/);
                    if (predictedPriceMatch) {
                        predictedPrice = parseFloat(predictedPriceMatch[1]);
                        predictedReturn = parseFloat(predictedPriceMatch[3]);
                    }
                } catch (error) {
                    console.error('Error parsing price data:', error);
                }
                
                // Create stock card
                const stockCard = document.createElement('div');
                stockCard.className = 'col-12 mb-4';
                
                // Build card content
                let cardHtml = `
                    <div class="stock-card card">
                        <div class="card-header">
                            <h4 class="mb-0">${symbol}${name ? ` - ${name}` : ''}</h4>
                        </div>
                        <div class="card-body">
                            <div class="price-section mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="current-price">
                                        <span class="text-muted">Current Price:</span>
                                        <h5 class="d-inline ms-2">£${currentPrice.toFixed(2)}</h5>
                                    </div>
                                    <div class="predicted-price text-end">
                                        <span class="text-muted">Predicted Price:</span>
                                        <h5 class="d-inline ms-2 ${predictedReturn >= 0 ? 'text-success' : 'text-danger'}">£${predictedPrice.toFixed(2)}</h5>
                                        <span class="${predictedReturn >= 0 ? 'text-success' : 'text-danger'} ms-2">
                                            (${predictedReturn >= 0 ? '+' : ''}${predictedReturn.toFixed(2)}%)
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="analysis-details">
                                <button class="btn btn-outline-primary w-100 mb-3" type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#stockDetails${index}" 
                                        aria-expanded="false" 
                                        aria-controls="stockDetails${index}">
                                    View Detailed Analysis
                                </button>
                                
                                <div id="stockDetails${index}" class="collapse">
                `;
                
                // Add sections for analysis
                const sections = {
                    'Technical Analysis': [],
                    'Fundamental Analysis': [],
                    'Market Sentiment': [],
                    'Recent Performance': []
                };
                
                let currentSection = '';
                lines.slice(3).forEach(line => {
                    const trimmedLine = line.trim();
                    if (Object.keys(sections).includes(trimmedLine.replace(':', ''))) {
                        currentSection = trimmedLine.replace(':', '');
                    } else if (currentSection && trimmedLine.startsWith('-')) {
                        const metricText = trimmedLine.substring(1).trim();
                        if (metricText) {
                            // Split on the first colon to handle cases with multiple colons
                            const colonIndex = metricText.indexOf(':');
                            if (colonIndex !== -1) {
                                const label = metricText.substring(0, colonIndex).trim();
                                const value = metricText.substring(colonIndex + 1).trim();
                                sections[currentSection].push({ label, value });
                            }
                        }
                    }
                });
                
                // Add sections to card
                Object.entries(sections).forEach(([sectionName, items]) => {
                    if (items.length > 0) {
                        cardHtml += `
                            <div class="analysis-section">
                                <h6 class="mb-3">${sectionName}</h6>
                                <div class="row g-3">
                        `;
                        
                        items.forEach(item => {
                            if (item.label && item.value) {
                                let valueClass = '';
                                if (item.value.includes('%')) {
                                    const numValue = parseFloat(item.value);
                                    if (!isNaN(numValue)) {
                                        valueClass = numValue >= 0 ? 'text-success' : 'text-danger';
                                    }
                                } else if (item.value.includes('/')) {
                                    const [num, den] = item.value.split('/');
                                    const score = parseFloat(num);
                                    if (!isNaN(score) && score >= 7) {
                                        valueClass = 'text-warning';
                                    }
                                }
                                
                                cardHtml += `
                                    <div class="col-md-6 col-lg-4">
                                        <div class="metric-box">
                                            <div class="metric-label">${item.label}</div>
                                            <div class="metric-value ${valueClass}">${item.value}</div>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        
                        cardHtml += `
                                </div>
                            </div>
                        `;
                    }
                });
                cardHtml += `
                            </div>
                        </div>
                    </div>
                `;
                
                stockCard.innerHTML = cardHtml;
                reportContent.appendChild(stockCard);
            });
        }
    </script>
</body>
</html>